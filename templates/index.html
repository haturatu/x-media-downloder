<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X Image Downloader</title>
<style>
    :root {
        --bg-color: #111;
        --surface-color: #1e1e1e;
        --primary-color: #007bff;
        --text-color: #ccc;
        --text-secondary-color: #888;
        --border-color: #333;
        --link-color: #3af;
        --tag-artist-color: #f88;
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    html { font-size: 14px; }
    body {
        font-family: var(--font-family); margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.5;
    }
    a { color: var(--link-color); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .container { display: flex; min-height: 100vh; }
    
    /* --- Sidebar --- */
    .sidebar {
        width: 250px; 
        background-color: var(--surface-color);
        border-right: 1px solid var(--border-color); 
        display: flex; 
        flex-direction: column; 
        padding: 0.75rem;
    }
    .sidebar h2 { 
        margin: 1rem 0 0.5rem 0; 
        font-size: 1rem; 
        font-weight: bold;
        color: var(--primary-color); 
    }
    .sidebar h2:first-child { margin-top: 0; }

    .download-section textarea { 
        width: 100%; box-sizing: border-box; background-color: var(--bg-color); 
        border: 1px solid var(--border-color); color: var(--text-color); 
        border-radius: 4px; padding: 0.5rem; resize: vertical; 
        min-height: 40px; font-size: 0.9rem; margin-bottom: 0.5rem;
    }
    .download-section button { 
        width: 100%; padding: 0.5rem 1rem; border: 1px solid var(--primary-color); 
        color: white; font-weight: bold; border-radius: 4px; cursor: pointer; 
        background-color: var(--primary-color); transition: background-color 0.2s; font-size: 0.9rem;
    }
    .download-section button:hover { background-color: #0056b3; }
    .download-section button:disabled { background-color: #444; cursor: not-allowed; }

    .search-box { 
        width: 100%; padding: 0.5rem; background-color: var(--bg-color); 
        border: 1px solid var(--border-color); border-radius: 4px; 
        color: var(--text-color); margin-bottom: 0.5rem; box-sizing: border-box; font-size: 0.9rem;
    }

    .sidebar-nav { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; margin-top: 1rem; }
    .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
    .sidebar-tab-btn { 
        flex: 1; background: none; border: none; color: var(--text-secondary-color); 
        padding: 0.5rem; font-size: 0.9rem; cursor: pointer; transition: color 0.2s, border-bottom 0.2s; 
        border-bottom: 2px solid transparent;
    }
    .sidebar-tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

    .sidebar-tab-content { flex-grow: 1; overflow-y: auto; padding-top: 0.75rem; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    .nav-list, .tag-list { list-style: none; padding: 0; margin: 0; font-size: 0.85rem; }
    .nav-list li, .tag-list li { margin-bottom: 1px; }

    .tag-list .tag-item, .nav-list .user-item-link {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.25rem 0.5rem; cursor: pointer; border-radius: 3px; 
    }
    .tag-list .tag-item:hover, .nav-list .user-item-link:hover { background-color: rgba(255, 255, 255, 0.08); }
    
    .tag-list .tag-item.active, .nav-list .user-item-link.active {
        background-color: rgba(0, 123, 255, 0.2);
        font-weight: bold;
    }
    .tag-list .tag-item > a { color: var(--link-color); }
    .nav-list .user-item-link > a { color: var(--tag-artist-color); }

    .item-count { color: var(--text-secondary-color); font-size: 0.8rem; margin-left: 0.5rem; }

    /* --- Main Content --- */
    .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: hidden; min-width: 0; }
    .header { padding: 0.5rem 1rem; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .header-title { display: flex; align-items: center; gap: 1rem; }
    .header h1 { margin: 0; font-size: 1.2rem; }
    .header-link { font-size: 1rem; color: var(--text-color); padding: 0.25rem 0.5rem; border-radius: 4px; }
    .header-link:hover { background-color: rgba(255,255,255,0.1); text-decoration: none; }
    .header-link.active { background-color: var(--primary-color); color: white; }

    .header-actions { display: flex; align-items: center; gap: 0.75rem; }
    .header .tag-search-form input { background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; padding: 0.4rem 0.6rem; font-size: 0.9rem; }
    .header .header-btn {
        padding: 0.4rem 0.8rem; border: 1px solid var(--border-color); 
        color: var(--text-color); font-weight: bold; border-radius: 4px; cursor: pointer; 
        background-color: #333; transition: background-color 0.2s; font-size: 0.9rem;
    }
    .header .header-btn:hover { background-color: #444; }
    
    #status { padding: 0.4rem 1rem; font-size: 0.8rem; color: var(--text-secondary-color); background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); min-height: 1.5rem; }
    .gallery-wrapper { flex-grow: 1; overflow-y: auto; padding: 0.75rem; }
    .gallery-title { margin: 0 0 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 1rem; }

    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
    .img-container { position: relative; cursor: pointer; overflow: hidden; border-radius: 4px; background-color: var(--surface-color); aspect-ratio: 1 / 1; }
    .image-grid img { width: 100%; height: 100%; display: block; object-fit: cover; }
    .img-container .tags-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; font-size: 0.7rem; padding: 3px 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0; transition: opacity 0.2s; }
    .img-container:hover .tags-overlay { opacity: 1; }

    .placeholder { text-align: center; color: var(--text-secondary-color); margin-top: 2rem; padding: 1rem; font-size: 0.9rem; }
    .loader { margin: 3rem auto; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- Modal --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; box-sizing: border-box; }
    .modal-content img { max-width: 100%; max-height: 85%; object-fit: contain; cursor: pointer; border-radius: 4px; }
    .modal-tags { color: #ccc; margin-top: 0.75rem; max-width: 80%; text-align: center; font-size: 0.9rem; }
    .modal-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.6); color: white; border: none; font-size: 1.2rem; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; user-select: none; transition: background-color 0.2s; }
    .modal-nav:hover { background-color: rgba(0,0,0,0.8); }
    .modal-nav.prev { left: 0.5rem; }
    .modal-nav.next { right: 0.5rem; }
    .modal-close { position: absolute; top: 0.5rem; right: 0.5rem; color: white; font-size: 1.5rem; cursor: pointer; background-color: rgba(0,0,0,0.6); width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
    .modal-close:hover { background-color: rgba(0,0,0,0.8); }
</style>
</head>
<body>

<div class="container">
    <aside class="sidebar">
        <h2>Downloader</h2>
        <div class="download-section">
            <textarea id="tweetUrls" placeholder="Enter Tweet URLs..." rows="3"></textarea>
            <button id="downloadBtn">Download</button>
        </div>

        <div class="sidebar-nav">
            <div class="sidebar-tabs">
                <button id="showUsersBtn" class="sidebar-tab-btn active">Users</button>
                <button id="showTagsBtn" class="sidebar-tab-btn">Tags</button>
            </div>
            <div class="sidebar-tab-content">
                <div id="usersPane" class="tab-pane active">
                    <input type="search" id="userSearch" class="search-box" placeholder="Search users...">
                    <ul id="navList" class="nav-list"></ul>
                </div>
                <div id="tagsPane" class="tab-pane">
                    <input type="search" id="tagSearch" class="search-box" placeholder="Search tags...">
                    <ul id="tagList" class="tag-list"></ul>
                </div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <div class="header-title">
                <h1>X Gallery</h1>
                <a href="#" id="homeBtn" class="header-link">üè† Home</a>
            </div>
            <div class="header-actions">
                <form id="tagSearchForm" class="tag-search-form">
                    <input type="search" id="tagSearchInput" placeholder="Search by tags (e.g. 1girl, blue_hair)">
                </form>
                <button id="autotagReloadBtn" class="header-btn">Autotagger Reload</button>
            </div>
        </header>
        <div id="status"></div>
        <div id="galleryWrapper" class="gallery-wrapper"></div>
    </main>
</div>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
        <span id="modalClose" class="modal-close">&times;</span>
        <button id="modalPrev" class="modal-nav prev">&#10094;</button>
        <img id="modalImg" src="">
        <div id="modalTags" class="modal-tags"></div>
        <button id="modalNext" class="modal-nav next">&#10095;</button>
    </div>
</div>

<script>
    const G_ELEMENTS = {
        // Header
        homeBtn: document.getElementById('homeBtn'),
        tagSearchForm: document.getElementById('tagSearchForm'),
        tagSearchInput: document.getElementById('tagSearchInput'),
        autotagReloadBtn: document.getElementById('autotagReloadBtn'),
        // Sidebar
        showUsersBtn: document.getElementById('showUsersBtn'),
        showTagsBtn: document.getElementById('showTagsBtn'),
        usersPane: document.getElementById('usersPane'),
        tagsPane: document.getElementById('tagsPane'),
        navList: document.getElementById('navList'),
        tagList: document.getElementById('tagList'),
        userSearch: document.getElementById('userSearch'),
        tagSearch: document.getElementById('tagSearch'),
        // Main
        galleryWrapper: document.getElementById('galleryWrapper'),
        status: document.getElementById('status'),
        // Actions
        downloadBtn: document.getElementById('downloadBtn'),
        tweetUrls: document.getElementById('tweetUrls'),
        // Modal
        modal: {
            overlay: document.getElementById('modalOverlay'),
            img: document.getElementById('modalImg'),
            tags: document.getElementById('modalTags'),
            close: document.getElementById('modalClose'),
            prev: document.getElementById('modalPrev'),
            next: document.getElementById('modalNext'),
        }
    };

    let G_STATE = {
        activeView: 'home', // 'home', 'user', 'tag'
        activeUser: null,
        activeTags: [],
        gallery: [],
        galleryIndex: 0,
        allUsers: [],
        allTags: [],
    };

    document.addEventListener('DOMContentLoaded', () => {
        initNav();
        initEventListeners();
        loadLatestImages();
    });

    function initNav() {
        loadUsers();
        loadAllTags();
    }

    function initEventListeners() {
        G_ELEMENTS.homeBtn.addEventListener('click', (e) => { e.preventDefault(); loadLatestImages(); });

        // Sidebar Tabs
        G_ELEMENTS.showUsersBtn.addEventListener('click', () => switchTab('users'));
        G_ELEMENTS.showTagsBtn.addEventListener('click', () => switchTab('tags'));

        // Search
        G_ELEMENTS.userSearch.addEventListener('input', () => renderNavList());
        G_ELEMENTS.tagSearch.addEventListener('input', () => renderTagList());
        G_ELEMENTS.tagSearchForm.addEventListener('submit', handleTagSearch);

        // Actions
        G_ELEMENTS.downloadBtn.addEventListener('click', handleDownload);
        G_ELEMENTS.autotagReloadBtn.addEventListener('click', handleAutotagReload);
        
        // Modal
        const { overlay, close, prev, next, img } = G_ELEMENTS.modal;
        overlay.addEventListener('click', e => (e.target === overlay || e.target === G_ELEMENTS.modal.tags) && closeModal());
        close.addEventListener('click', closeModal);
        prev.addEventListener('click', () => changeModalImage(-1));
        next.addEventListener('click', () => changeModalImage(1));
        img.addEventListener('click', () => changeModalImage(1));
        
        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                G_ELEMENTS.downloadBtn.click();
                return;
            }
            if (!overlay.classList.contains('visible')) return;
            if (e.key === 'ArrowRight') changeModalImage(1);
            if (e.key === 'ArrowLeft') changeModalImage(-1);
            if (e.key === 'Escape') closeModal();
        });
    }

    function switchTab(tabName) {
        if (tabName === 'users') {
            G_ELEMENTS.usersPane.classList.add('active');
            G_ELEMENTS.tagsPane.classList.remove('active');
            G_ELEMENTS.showUsersBtn.classList.add('active');
            G_ELEMENTS.showTagsBtn.classList.remove('active');
        } else {
            G_ELEMENTS.usersPane.classList.remove('active');
            G_ELEMENTS.tagsPane.classList.add('active');
            G_ELEMENTS.showUsersBtn.classList.remove('active');
            G_ELEMENTS.showTagsBtn.classList.add('active');
        }
    }

    async function fetchAPI(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error(`Fetch error for ${url}:`, error);
            G_ELEMENTS.status.textContent = `Error: ${error.message}`;
            G_ELEMENTS.galleryWrapper.innerHTML = `<p class="placeholder">Failed to load data. Please try again.</p>`;
            return null;
        }
    }

    async function loadLatestImages() {
        setActiveNav({ view: 'home' });
        renderLoader();
        const data = await fetchAPI('/api/images?sort=latest&limit=100');
        if (data) {
            const title = 'Latest Posts';
            if (data.images.length === 0) {
                renderPlaceholder(title, 'No images found. Start by downloading some!');
                return;
            }
            renderImageGrid(title, data.images);
        }
    }

    async function loadImagesByTags(tags) {
        const tagString = tags.join(',');
        setActiveNav({ view: 'tag', tags });
        renderLoader();
        const data = await fetchAPI(`/api/images?tags=${encodeURIComponent(tagString)}&limit=500`);
        if (data) {
            const title = `Tagged with: ${tagString}`;
            if (data.images.length === 0) {
                renderPlaceholder(title, 'No images found with these tags.');
                return;
            }
            renderImageGrid(title, data.images);
        }
    }

    async function loadUserImages(username) {
        setActiveNav({ view: 'user', user: username });
        renderLoader();
        const data = await fetchAPI(`/api/users/${username}/tweets`);
        if (data && data.tweets) {
            const allImages = data.tweets.flatMap(tweet => tweet.images);
            renderImageGrid(`@${username}`, allImages);
        }
    }

    async function loadUsers() {
        const data = await fetchAPI(`/api/users`);
        if (data) {
            G_STATE.allUsers = data.users;
            renderNavList();
        }
    }

    async function loadAllTags() {
        const data = await fetchAPI('/api/tags');
        if (data) {
            G_STATE.allTags = data.tags;
            renderTagList();
        }
    }

    async function handleDownload() {
        const urls = G_ELEMENTS.tweetUrls.value.trim().split(/[\s,]+/).filter(Boolean);
        if (!urls.length) { alert("Please enter at least one URL."); return; }
        
        G_ELEMENTS.downloadBtn.disabled = true;
        G_ELEMENTS.status.textContent = "Sending to background queue...";

        try {
            const data = await fetchAPI('/api/download', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ urls })
            });
            if (!data) {
                // fetchAPI already handles setting the status on error
                return;
            }

            G_ELEMENTS.status.textContent = data.message || "Tasks queued successfully.";
            G_ELEMENTS.tweetUrls.value = '';
            
            // Refresh the UI after a short delay to give workers time to start.
            setTimeout(() => {
                initNav();
                if (G_STATE.activeView === 'home') {
                    loadLatestImages();
                }
            }, 3000);

        } catch (error) {
            G_ELEMENTS.status.textContent = `Error: ${error.message}`;
        } finally {
            G_ELEMENTS.downloadBtn.disabled = false;
        }
    }

    async function handleAutotagReload() {
        if (!confirm('This will clear all existing tags and re-tag every image. This can take a long time. Are you sure?')) return;

        G_ELEMENTS.autotagReloadBtn.disabled = true;
        G_ELEMENTS.status.textContent = "Starting autotagger reload... Existing tags will be cleared.";

        const data = await fetchAPI('/api/autotag/reload', { method: 'POST' });
        if (data) {
            G_ELEMENTS.status.textContent = data.message;
            setTimeout(loadAllTags, 5000); // Refresh tags after 5s
        } else {
             G_ELEMENTS.status.textContent = "Failed to start autotagger reload.";
        }
        G_ELEMENTS.autotagReloadBtn.disabled = false;
    }

    function handleTagSearch(event) {
        event.preventDefault();
        const query = G_ELEMENTS.tagSearchInput.value.trim();
        if (query) {
            const tags = query.split(',').map(t => t.trim().replace(/ /g, '_')).filter(Boolean);
            if (tags.length > 0) {
                loadImagesByTags(tags);
            }
        }
    }

    function renderNavList() {
        G_ELEMENTS.navList.innerHTML = '';
        const query = G_ELEMENTS.userSearch.value.toLowerCase();
        const filteredUsers = (G_STATE.allUsers || []).filter(u => u.username.toLowerCase().includes(query));

        filteredUsers.forEach(user => {
            const li = document.createElement('li');
            li.className = 'user-item-link';
            li.dataset.userId = user.username;
            li.innerHTML = `<a href="#">${user.username}</a><span class="item-count">${user.tweet_count}</span>`;
            li.onclick = (e) => { 
                e.preventDefault();
                loadUserImages(user.username);
            };
            G_ELEMENTS.navList.appendChild(li);
        });
        setActiveNav(G_STATE);
    }

    function renderTagList() {
        G_ELEMENTS.tagList.innerHTML = '';
        const query = G_ELEMENTS.tagSearch.value.toLowerCase();
        const filteredTags = (G_STATE.allTags || []).filter(t => t.tag.includes(query));
        
        filteredTags.forEach(tagInfo => {
            const li = document.createElement('li');
            li.className = 'tag-item';
            li.dataset.tag = tagInfo.tag;
            li.innerHTML = `<a href="#">${tagInfo.tag}</a><span class="item-count">${tagInfo.count}</span>`;
            li.onclick = (e) => { 
                e.preventDefault();
                loadImagesByTags([tagInfo.tag]);
            };
            G_ELEMENTS.tagList.appendChild(li);
        });
        setActiveNav(G_STATE);
    }
    
    function renderImageGrid(title, images) {
        G_STATE.gallery = images;
        G_ELEMENTS.galleryWrapper.innerHTML = '';

        if (title) {
            const gridTitle = document.createElement('h3');
            gridTitle.className = 'gallery-title';
            gridTitle.textContent = title;
            G_ELEMENTS.galleryWrapper.appendChild(gridTitle);
        }
        
        const grid = document.createElement('div');
        grid.className = 'image-grid';

        images.forEach((img, index) => {
            const container = document.createElement('div');
            container.className = 'img-container';
            const imageEl = document.createElement('img');
            imageEl.src = `/images/${img.path}`;
            imageEl.loading = 'lazy';
            imageEl.onclick = () => showModal(index);
            
            const tagsOverlay = document.createElement('div');
            tagsOverlay.className = 'tags-overlay';
            tagsOverlay.textContent = img.tags.slice(0, 5).map(t => t.tag).join(', ');

            container.appendChild(imageEl);
            container.appendChild(tagsOverlay);
            grid.appendChild(container);
        });
        G_ELEMENTS.galleryWrapper.appendChild(grid);
    }
    
    function renderLoader() {
        G_ELEMENTS.galleryWrapper.innerHTML = '<div class="loader"></div>';
    }

    function renderPlaceholder(title, message) {
        let html = '';
        if (title) html += `<h3 class="gallery-title">${title}</h3>`;
        html += `<p class="placeholder">${message}</p>`;
        G_ELEMENTS.galleryWrapper.innerHTML = html;
    }
    
    function setActiveNav({ view, user = null, tags = [] }) {
        G_STATE.activeView = view;
        G_STATE.activeUser = user;
        G_STATE.activeTags = tags;

        document.querySelectorAll('.nav-list .active, .tag-list .active, .header-link.active').forEach(el => el.classList.remove('active'));

        if (view === 'home') {
            G_ELEMENTS.homeBtn.classList.add('active');
        } else if (view === 'user') {
            const userItem = document.querySelector(`.nav-list .user-item-link[data-user-id='${user}']`);
            userItem?.classList.add('active');
        } else if (view === 'tag') {
            tags.forEach(tag => {
                document.querySelector(`.tag-list .tag-item[data-tag='${tag}']`)?.classList.add('active');
            });
        }
    }

    function showModal(index) {
        G_STATE.galleryIndex = index;
        updateModalImage();
        G_ELEMENTS.modal.overlay.classList.add('visible');
    }

    function closeModal() {
        G_ELEMENTS.modal.overlay.classList.remove('visible');
    }

    function updateModalImage() {
        if (G_STATE.gallery.length > 0) {
            const image = G_STATE.gallery[G_STATE.galleryIndex];
            G_ELEMENTS.modal.img.src = `/images/${image.path}`;
            G_ELEMENTS.modal.tags.textContent = image.tags.map(t => t.tag).join(', ');
        }
    }

    function changeModalImage(direction) {
        const newIndex = G_STATE.galleryIndex + direction;
        const len = G_STATE.gallery.length;
        G_STATE.galleryIndex = (newIndex % len + len) % len;
        updateModalImage();
    }
</script>
</body>
</html>
