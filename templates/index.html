
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X Image Downloader Pro</title>
<style>
    :root {
        --bg-color: #000;
        --surface-color: #1a1a1a;
        --primary-color: #007bff;
        --text-color: #e0e0e0;
        --text-secondary-color: #888;
        --border-color: #333;
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    html { font-size: 16px; }
    body {
        font-family: var(--font-family); margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6;
    }
    .container { display: flex; min-height: 100vh; }
    
    /* --- Sidebar --- */
    .sidebar {
        width: 280px; 
        background-color: var(--surface-color); 
        border-right: 1px solid var(--border-color); 
        display: flex; 
        flex-direction: column; 
        padding: 1rem;
    }
    .sidebar h2 { 
        margin: 1.5rem 0 1rem 0; 
        font-size: 1.2rem; 
        color: var(--primary-color); 
    }
    .sidebar h2:first-child { margin-top: 0; }

    .download-section button, .autotag-section button { 
        width: 100%;
        padding: 0.75rem 1.5rem; 
        border: none; 
        color: white; 
        font-weight: bold; 
        border-radius: 8px; 
        cursor: pointer; 
        transition: background-color 0.2s;
        font-size: 1rem;
    }
    .download-section button { background-color: var(--primary-color); }
    .download-section button:hover { background-color: #0056b3; }
    .download-section button:disabled { background-color: #555; cursor: not-allowed; }
    .autotag-section button { background-color: #444; }
    .autotag-section button:hover { background-color: #555; }

    .download-section textarea { 
        width: 100%; box-sizing: border-box; background-color: var(--bg-color); 
        border: 1px solid var(--border-color); color: var(--text-color); 
        border-radius: 8px; padding: 0.75rem; resize: vertical; 
        min-height: 48px; font-size: 1rem; margin-bottom: 0.5rem;
    }

    .search-box { 
        width: 100%; padding: 0.75rem; background-color: var(--bg-color); 
        border: 1px solid var(--border-color); border-radius: 8px; 
        color: var(--text-color); margin-bottom: 1rem; box-sizing: border-box; font-size: 1rem;
    }

    .nav-container { flex-grow: 1; overflow-y: auto; }
    .nav-list, .tag-list { list-style: none; padding: 0; margin: 0; }
    .nav-list li, .tag-list li { margin-bottom: 0.25rem; }

    .nav-list li.home-link, .tag-list .tag-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.75rem; cursor: pointer; border-radius: 8px; transition: background-color 0.2s;
    }
    .nav-list li.home-link:hover, .tag-list .tag-item:hover { background-color: rgba(255, 255, 255, 0.08); }
    .nav-list li.home-link.active, .tag-list .tag-item.active { background-color: rgba(0, 123, 255, 0.2); font-weight: bold; }

    .item-count { color: var(--text-secondary-color); font-size: 0.9rem; }

    .nav-list .user-header {
        display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; padding: 0.75rem; border-radius: 8px; transition: background-color 0.2s;
    }
    .nav-list .user-header:hover { background-color: rgba(255, 255, 255, 0.08); }
    .nav-list .user-item.active > .user-header { font-weight: bold; color: var(--primary-color); }
    .nav-list .tweet-list { list-style: none; padding: 0 0 0 1.5rem; margin: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .nav-list .user-item.open > .tweet-list { max-height: 500px; overflow-y: auto; }
    .nav-list .tweet-list li { padding: 0.5rem 0.75rem; cursor: pointer; border-radius: 6px; color: var(--text-secondary-color); transition: background-color 0.2s, color 0.2s; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .nav-list .tweet-list li:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--text-color); }
    .nav-list .tweet-list li.active { color: var(--primary-color); font-weight: 600; }

    /* --- Main Content --- */
    .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-y: hidden; min-width: 0; }
    .header { padding: 1rem; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .header h1 { margin: 0; font-size: 1.5rem; }
    .header .tag-search-form { display: flex; gap: 0.5rem; }
    .header .tag-search-form input { background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 8px; padding: 0.5rem 0.75rem; font-size: 1rem; }
    
    #status { padding: 0.5rem 1rem; font-size: 0.9rem; color: var(--text-secondary-color); background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); }
    .gallery-wrapper { flex-grow: 1; overflow-y: auto; padding: 1rem; }
    .gallery-title { margin: 0 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 1.1rem; }

    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
    .img-container { position: relative; cursor: pointer; overflow: hidden; border-radius: 8px; background-color: var(--surface-color); transition: transform 0.2s ease, box-shadow 0.2s ease; aspect-ratio: 1 / 1; }
    .img-container:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .image-grid img { width: 100%; height: 100%; display: block; object-fit: cover; }
    .img-container .tags-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; font-size: 0.75rem; padding: 4px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0; transition: opacity 0.2s; }
    .img-container:hover .tags-overlay { opacity: 1; }

    .placeholder { text-align: center; color: var(--text-secondary-color); margin-top: 3rem; padding: 2rem; font-size: 1rem; }
    .loader { margin: 3rem auto; width: 48px; height: 48px; border: 4px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- Modal --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; box-sizing: border-box; }
    .modal-content img { max-width: 100%; max-height: 85%; object-fit: contain; cursor: pointer; border-radius: 8px; }
    .modal-tags { color: #ccc; margin-top: 1rem; max-width: 80%; text-align: center; }
    .modal-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.7); color: white; border: none; font-size: 1.5rem; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; user-select: none; transition: background-color 0.2s, transform 0.2s; }
    .modal-nav:hover { background-color: rgba(0,0,0,0.9); transform: translateY(-50%) scale(1.1); }
    .modal-nav.prev { left: 1rem; }
    .modal-nav.next { right: 1rem; }
    .modal-close { position: absolute; top: 1rem; right: 1rem; color: white; font-size: 2rem; cursor: pointer; background-color: rgba(0,0,0,0.7); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
    .modal-close:hover { background-color: rgba(0,0,0,0.9); }
</style>
</head>
<body>

<div class="container">
    <aside class="sidebar">
        <h2>Downloader</h2>
        <div class="download-section">
            <textarea id="tweetUrls" placeholder="Enter Tweet URLs..." rows="3"></textarea>
            <button id="downloadBtn">Download</button>
        </div>

        <div class="nav-container">
            <h2>Users</h2>
            <input type="search" id="userSearch" class="search-box" placeholder="Search users...">
            <ul id="navList" class="nav-list"></ul>

            <h2>Tags</h2>
            <input type="search" id="tagSearch" class="search-box" placeholder="Search tags...">
            <ul id="tagList" class="tag-list"></ul>
        </div>

        <div class="autotag-section">
            <button id="autotagReloadBtn">Autotagger Reload</button>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1>X Gallery</h1>
            <form id="tagSearchForm" class="tag-search-form">
                <input type="search" id="tagSearchInput" placeholder="Search by tags (e.g. 1girl, blue_hair)">
            </form>
        </header>
        <div id="status"></div>
        <div id="galleryWrapper" class="gallery-wrapper"></div>
    </main>
</div>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
        <span id="modalClose" class="modal-close">&times;</span>
        <button id="modalPrev" class="modal-nav prev">&#10094;</button>
        <img id="modalImg" src="">
        <div id="modalTags" class="modal-tags"></div>
        <button id="modalNext" class="modal-nav next">&#10095;</button>
    </div>
</div>

<script>
    const G_ELEMENTS = {
        navList: document.getElementById('navList'),
        tagList: document.getElementById('tagList'),
        userSearch: document.getElementById('userSearch'),
        tagSearch: document.getElementById('tagSearch'),
        tagSearchForm: document.getElementById('tagSearchForm'),
        tagSearchInput: document.getElementById('tagSearchInput'),
        galleryWrapper: document.getElementById('galleryWrapper'),
        status: document.getElementById('status'),
        downloadBtn: document.getElementById('downloadBtn'),
        autotagReloadBtn: document.getElementById('autotagReloadBtn'),
        tweetUrls: document.getElementById('tweetUrls'),
        modal: {
            overlay: document.getElementById('modalOverlay'),
            img: document.getElementById('modalImg'),
            tags: document.getElementById('modalTags'),
            close: document.getElementById('modalClose'),
            prev: document.getElementById('modalPrev'),
            next: document.getElementById('modalNext'),
        }
    };

    let G_STATE = {
        activeView: 'home', // 'home', 'user', 'tag'
        activeUser: null,
        activeTweet: null,
        activeTags: [],
        gallery: [],
        galleryIndex: 0,
        allTags: [],
    };

    document.addEventListener('DOMContentLoaded', () => {
        initNav();
        initEventListeners();
        loadLatestImages();
    });

    function initNav() {
        loadUsers();
        loadAllTags();
    }

    function initEventListeners() {
        G_ELEMENTS.userSearch.addEventListener('input', () => loadUsers(G_ELEMENTS.userSearch.value));
        G_ELEMENTS.tagSearch.addEventListener('input', () => renderTagList(G_ELEMENTS.tagSearch.value));
        G_ELEMENTS.tagSearchForm.addEventListener('submit', handleTagSearch);
        G_ELEMENTS.downloadBtn.addEventListener('click', handleDownload);
        G_ELEMENTS.autotagReloadBtn.addEventListener('click', handleAutotagReload);
        
        const { overlay, close, prev, next, img } = G_ELEMENTS.modal;
        overlay.addEventListener('click', e => (e.target === overlay || e.target === G_ELEMENTS.modal.tags) && closeModal());
        close.addEventListener('click', closeModal);
        prev.addEventListener('click', () => changeModalImage(-1));
        next.addEventListener('click', () => changeModalImage(1));
        img.addEventListener('click', () => changeModalImage(1));
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                G_ELEMENTS.downloadBtn.click();
                return;
            }
            if (!overlay.classList.contains('visible')) return;
            if (e.key === 'ArrowRight') changeModalImage(1);
            if (e.key === 'ArrowLeft') changeModalImage(-1);
            if (e.key === 'Escape') closeModal();
        });
    }

    async function fetchAPI(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error(`Fetch error for ${url}:`, error);
            G_ELEMENTS.galleryWrapper.innerHTML = `<p class="placeholder">Failed to load data. Please try again.</p>`;
            return null;
        }
    }

    async function loadLatestImages() {
        setActiveNav({ view: 'home' });
        renderLoader();
        const data = await fetchAPI('/api/images?sort=latest&limit=100');
        if (data) {
            const title = 'Latest Posts';
            if (data.images.length === 0) {
                renderPlaceholder(title, 'No images found. Start by downloading some!');
                return;
            }
            renderImageGrid(title, data.images);
        }
    }

    async function loadImagesByTags(tags) {
        const tagString = tags.join(',');
        setActiveNav({ view: 'tag', tags });
        renderLoader();
        const data = await fetchAPI(`/api/images?tags=${encodeURIComponent(tagString)}&limit=500`);
        if (data) {
            const title = `Tagged with: ${tagString}`;
            if (data.images.length === 0) {
                renderPlaceholder(title, 'No images found with these tags.');
                return;
            }
            renderImageGrid(title, data.images);
        }
    }

    async function loadUsers(query = '') {
        const data = await fetchAPI(`/api/users?q=${encodeURIComponent(query)}`);
        if (data) renderNavList(data.users);
    }

    async function loadAllTags(query = '') {
        const data = await fetchAPI('/api/tags');
        if (data) {
            G_STATE.allTags = data.tags;
            renderTagList();
        }
    }

    async function toggleUserTweets(username, userItem) {
        const tweetList = userItem.querySelector('.tweet-list');
        const isAlreadyOpen = userItem.classList.contains('open');

        document.querySelectorAll('#navList .user-item.open').forEach(item => {
            if (item !== userItem) item.classList.remove('open');
        });

        if (isAlreadyOpen) {
            userItem.classList.remove('open');
        } else {
            userItem.classList.add('open');
            setActiveNav({ view: 'user', user: username });
            if (!tweetList.hasChildNodes()) {
                const data = await fetchAPI(`/api/users/${username}/tweets`);
                if (data && data.tweets) {
                    data.tweets.forEach(tweet => {
                        const li = document.createElement('li');
                        li.dataset.tweetId = tweet.tweet_id;
                        li.textContent = tweet.tweet_id;
                        li.onclick = (e) => {
                            e.stopPropagation();
                            loadTweetImages(username, tweet.tweet_id, tweet.images, li);
                        };
                        tweetList.appendChild(li);
                    });
                }
            }
        }
    }

    function loadTweetImages(username, tweetId, images, tweetLi) {
        setActiveNav({ view: 'user', user: username, tweet: tweetId });
        renderImageGrid(`@${username} / ${tweetId}`, images);
    }

    async function handleDownload() {
        const urls = G_ELEMENTS.tweetUrls.value.trim().split(/[\s,]+/).filter(Boolean);
        if (!urls.length) { alert("Please enter at least one URL."); return; }
        
        G_ELEMENTS.downloadBtn.disabled = true;
        G_ELEMENTS.status.textContent = "Downloading...";

        try {
            const response = await fetch('/api/download', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ urls })
            });
            const data = await response.json();
            const totalDownloaded = data.results.reduce((sum, r) => sum + (r.downloaded_count || 0), 0);
            G_ELEMENTS.status.textContent = `Completed! Downloaded ${totalDownloaded} new images.`;
            G_ELEMENTS.tweetUrls.value = '';
            initNav();
            if (G_STATE.activeView === 'home') {
                loadLatestImages();
            }
        } catch (error) {
            G_ELEMENTS.status.textContent = "An error occurred during download.";
            console.error("Download error:", error);
        } finally {
            G_ELEMENTS.downloadBtn.disabled = false;
        }
    }

    async function handleAutotagReload() {
        if (!confirm('This will clear all existing tags and re-tag every image. This can take a long time. Are you sure?')) return;

        G_ELEMENTS.autotagReloadBtn.disabled = true;
        G_ELEMENTS.status.textContent = "Starting autotagger reload... Existing tags will be cleared.";

        const data = await fetchAPI('/api/autotag/reload', { method: 'POST' });
        if (data) {
            G_ELEMENTS.status.textContent = data.message;
        } else {
            G_ELEMENTS.status.textContent = "Failed to start autotagger reload.";
        }
        G_ELEMENTS.autotagReloadBtn.disabled = false;
    }

    function handleTagSearch(event) {
        event.preventDefault();
        const query = G_ELEMENTS.tagSearchInput.value.trim();
        if (query) {
            const tags = query.split(',').map(t => t.trim()).filter(Boolean);
            if (tags.length > 0) {
                loadImagesByTags(tags);
            }
        }
    }

    function renderNavList(users) {
        G_ELEMENTS.navList.innerHTML = '';
        const homeLi = document.createElement('li');
        homeLi.dataset.navId = 'home';
        homeLi.classList.add('home-link');
        homeLi.innerHTML = `<span>🏠 All Posts</span>`;
        homeLi.onclick = loadLatestImages;
        G_ELEMENTS.navList.appendChild(homeLi);

        users.forEach(user => {
            const userItem = document.createElement('li');
            userItem.classList.add('user-item');
            userItem.dataset.navId = user.username;
            const userHeader = document.createElement('div');
            userHeader.className = 'user-header';
            userHeader.innerHTML = `<span>${user.username}</span><span class="item-count">${user.tweet_count}</span>`;
            userHeader.onclick = () => toggleUserTweets(user.username, userItem);
            const tweetList = document.createElement('ul');
            tweetList.className = 'tweet-list';
            userItem.appendChild(userHeader);
            userItem.appendChild(tweetList);
            G_ELEMENTS.navList.appendChild(userItem);
        });
        setActiveNav({ view: G_STATE.activeView, user: G_STATE.activeUser, tweet: G_STATE.activeTweet, tags: G_STATE.activeTags });
    }

    function renderTagList(query = '') {
        G_ELEMENTS.tagList.innerHTML = '';
        const filteredTags = G_STATE.allTags.filter(t => t.tag.includes(query.toLowerCase()));
        
        filteredTags.forEach(tagInfo => {
            const tagItem = document.createElement('li');
            tagItem.className = 'tag-item';
            tagItem.dataset.tag = tagInfo.tag;
            tagItem.innerHTML = `<span>${tagInfo.tag}</span><span class="item-count">${tagInfo.count}</span>`;
            tagItem.onclick = () => loadImagesByTags([tagInfo.tag]);
            G_ELEMENTS.tagList.appendChild(tagItem);
        });
        setActiveNav({ view: G_STATE.activeView, user: G_STATE.activeUser, tweet: G_STATE.activeTweet, tags: G_STATE.activeTags });
    }
    
    function renderImageGrid(title, images) {
        G_STATE.gallery = images;
        G_ELEMENTS.galleryWrapper.innerHTML = '';

        if (title) {
            const gridTitle = document.createElement('h3');
            gridTitle.className = 'gallery-title';
            gridTitle.textContent = title;
            G_ELEMENTS.galleryWrapper.appendChild(gridTitle);
        }
        
        const grid = document.createElement('div');
        grid.className = 'image-grid';

        images.forEach((img, index) => {
            const container = document.createElement('div');
            container.className = 'img-container';
            const imageEl = document.createElement('img');
            imageEl.src = `/images/${img.path}`;
            imageEl.loading = 'lazy';
            imageEl.onclick = () => showModal(index);
            
            const tagsOverlay = document.createElement('div');
            tagsOverlay.className = 'tags-overlay';
            tagsOverlay.textContent = img.tags.slice(0, 5).map(t => t.tag).join(', ');

            container.appendChild(imageEl);
            container.appendChild(tagsOverlay);
            grid.appendChild(container);
        });
        G_ELEMENTS.galleryWrapper.appendChild(grid);
    }
    
    function renderLoader() {
        G_ELEMENTS.galleryWrapper.innerHTML = '<div class="loader"></div>';
    }

    function renderPlaceholder(title, message) {
        let html = '';
        if (title) html += `<h3 class="gallery-title">${title}</h3>`;
        html += `<p class="placeholder">${message}</p>`;
        G_ELEMENTS.galleryWrapper.innerHTML = html;
    }
    
    function setActiveNav({ view, user = null, tweet = null, tags = [] }) {
        G_STATE.activeView = view;
        G_STATE.activeUser = user;
        G_STATE.activeTweet = tweet;
        G_STATE.activeTags = tags;

        // Reset all active states
        document.querySelectorAll('#navList .active, #tagList .active').forEach(el => el.classList.remove('active'));

        if (view === 'home') {
            document.querySelector('#navList .home-link')?.classList.add('active');
        } else if (view === 'user') {
            const userItem = document.querySelector(`#navList .user-item[data-nav-id='${user}']`);
            if (userItem) {
                userItem.classList.add('active');
                if (tweet) {
                    userItem.classList.add('open');
                    userItem.querySelector(`.tweet-list li[data-tweet-id='${tweet}']`)?.classList.add('active');
                }
            }
        } else if (view === 'tag') {
            tags.forEach(tag => {
                document.querySelector(`#tagList .tag-item[data-tag='${tag}']`)?.classList.add('active');
            });
        }
    }

    function showModal(index) {
        G_STATE.galleryIndex = index;
        updateModalImage();
        G_ELEMENTS.modal.overlay.classList.add('visible');
    }

    function closeModal() {
        G_ELEMENTS.modal.overlay.classList.remove('visible');
    }

    function updateModalImage() {
        if (G_STATE.gallery.length > 0) {
            const image = G_STATE.gallery[G_STATE.galleryIndex];
            G_ELEMENTS.modal.img.src = `/images/${image.path}`;
            G_ELEMENTS.modal.tags.textContent = image.tags.map(t => t.tag).join(', ');
        }
    }

    function changeModalImage(direction) {
        const newIndex = G_STATE.galleryIndex + direction;
        const len = G_STATE.gallery.length;
        G_STATE.galleryIndex = (newIndex % len + len) % len;
        updateModalImage();
    }
</script>
</body>
</html>
