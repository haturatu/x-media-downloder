<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X Image Downloader Pro</title>
<style>
    :root {
        --bg-color: #1a1a1a;
        --surface-color: #242424;
        --primary-color: #1da1f2;
        --text-color: #e0e0e0;
        --text-secondary-color: #888;
        --border-color: #333;
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    html { font-size: 16px; }
    body {
        font-family: var(--font-family); margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6;
    }
    .container { display: flex; min-height: 100vh; }
    
    /* --- モバイルメニュートグル --- */
    .mobile-menu-toggle {
        display: none;
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 1001;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    }
    .mobile-menu-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .mobile-overlay {
    /* 既存のスタイルに追加 */
    pointer-events: none;
}

    .mobile-overlay.visible {
    pointer-events: auto;
}
    
    /* --- サイドバー --- */
    .sidebar {
        width: 280px; 
        background-color: var(--surface-color); 
        border-right: 1px solid var(--border-color); 
        display: flex; 
        flex-direction: column; 
        padding: 1rem;
        transition: transform 0.3s ease;
    }
    .sidebar h2 { 
        margin: 0 0 1rem 0; 
        font-size: 1.2rem; 
        color: var(--primary-color); 
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .sidebar-close {
        display: none;
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    .sidebar-close:hover {
        background-color: rgba(255,255,255,0.1);
    }
    
    .search-box { 
        width: 100%; 
        padding: 0.75rem; 
        background-color: var(--bg-color); 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        color: var(--text-color); 
        margin-bottom: 1rem; 
        box-sizing: border-box;
        font-size: 1rem;
    }
    .nav-list { 
        list-style: none; 
        padding: 0; 
        margin: 0; 
        overflow-y: auto; 
        flex-grow: 1; 
    }
    .nav-list li { 
        padding: 0.75rem; 
        cursor: pointer; 
        border-radius: 8px; 
        transition: background-color 0.2s; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        margin-bottom: 0.25rem;
    }
    .nav-list li:hover { background-color: rgba(255, 255, 255, 0.08); }
    .nav-list li.active { background-color: rgba(29, 161, 242, 0.2); font-weight: bold; }
    .nav-list .tweet-count { color: var(--text-secondary-color); font-size: 0.9rem; }

    /* --- メインコンテンツ --- */
    .main-content { 
        flex-grow: 1; 
        display: flex; 
        flex-direction: column; 
        overflow-y: hidden; 
        min-width: 0;
    }
    .header { 
        padding: 1rem; 
        background-color: var(--surface-color); 
        border-bottom: 1px solid var(--border-color); 
        display: flex; 
        gap: 1rem; 
        flex-wrap: wrap;
    }
    .header textarea { 
        flex: 1; 
        min-width: 200px;
        background-color: var(--bg-color); 
        border: 1px solid var(--border-color); 
        color: var(--text-color); 
        border-radius: 8px; 
        padding: 0.75rem; 
        resize: vertical; 
        min-height: 48px;
        font-size: 1rem;
    }
    .header button { 
        padding: 0.75rem 1.5rem; 
        background-color: var(--primary-color); 
        border: none; 
        color: white; 
        font-weight: bold; 
        border-radius: 8px; 
        cursor: pointer; 
        transition: background-color 0.2s;
        font-size: 1rem;
        min-height: 48px;
        white-space: nowrap;
    }
    .header button:hover { background-color: #1a91da; }
    .header button:disabled { background-color: #555; cursor: not-allowed; }
    
    #status { 
        padding: 0.75rem 1rem; 
        font-size: 0.9rem; 
        min-height: 1.5rem; 
        color: var(--text-secondary-color); 
        background-color: var(--bg-color);
        border-bottom: 1px solid var(--border-color);
    }

    .gallery-wrapper { 
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 1rem; 
    }
    .gallery-title { 
        margin: 0 0 1rem; 
        padding-bottom: 0.5rem; 
        border-bottom: 1px solid var(--border-color); 
        font-size: 1.1rem;
    }

    /* ✨ Masonry Layout for Image Grid ✨ */
    .image-grid {
        column-count: 4;
        column-gap: 12px;
    }
    .img-container {
        break-inside: avoid;
        margin-bottom: 12px;
        cursor: pointer;
        overflow: hidden;
        border-radius: 8px;
        background-color: var(--surface-color);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .img-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .image-grid img {
        width: 100%;
        height: auto;
        display: block;
        object-fit: cover;
    }

    /* ローディングとプレースホルダー */
    .placeholder { 
        text-align: center; 
        color: var(--text-secondary-color); 
        margin-top: 3rem; 
        padding: 2rem;
        font-size: 1rem;
    }
    .loader { 
        margin: 3rem auto; 
        width: 48px; 
        height: 48px; 
        border: 4px solid var(--border-color); 
        border-top-color: var(--primary-color); 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- モーダル --- */
    .modal-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0, 0, 0, 0.95); 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        z-index: 2000; 
        opacity: 0; 
        visibility: hidden; 
        transition: opacity 0.3s, visibility 0.3s; 
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { 
        position: relative; 
        width: 100%; 
        height: 100%; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        padding: 2rem;
        box-sizing: border-box;
    }
    .modal-content img { 
        max-width: 100%; 
        max-height: 100%; 
        object-fit: contain; 
        cursor: pointer;
        border-radius: 8px;
    }
    .modal-nav { 
        position: absolute; 
        top: 50%; 
        transform: translateY(-50%); 
        background-color: rgba(0,0,0,0.7); 
        color: white; 
        border: none; 
        font-size: 1.5rem; 
        width: 48px; 
        height: 48px; 
        border-radius: 50%; 
        cursor: pointer; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        user-select: none; 
        transition: background-color 0.2s, transform 0.2s; 
    }
    .modal-nav:hover { 
        background-color: rgba(0,0,0,0.9); 
        transform: translateY(-50%) scale(1.1);
    }
    .modal-nav.prev { left: 1rem; }
    .modal-nav.next { right: 1rem; }
    .modal-close { 
        position: absolute; 
        top: 1rem; 
        right: 1rem; 
        color: white; 
        font-size: 2rem; 
        cursor: pointer; 
        background-color: rgba(0,0,0,0.7);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }
    .modal-close:hover {
        background-color: rgba(0,0,0,0.9);
    }

    /* --- モバイル & タブレット対応 --- */
    @media (max-width: 1200px) { 
        .image-grid { column-count: 3; column-gap: 10px; } 
        .img-container { margin-bottom: 10px; }
    }
    
    @media (max-width: 768px) { 
        .mobile-menu-toggle { display: flex; align-items: center; justify-content: center; }
        
        .sidebar { 
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            transform: translateX(-100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-close { display: flex; }
        
        .main-content { 
            width: 100%;
            padding-top: 0;
        }
        
        .header {
            padding: 1rem;
            padding-top: 4.5rem;
        }
        .header textarea { min-width: 150px; }
        
        .image-grid { 
            column-count: 2; 
            column-gap: 8px;
        }
        .img-container { margin-bottom: 8px; }
        
        .modal-nav { 
            width: 44px; 
            height: 44px; 
            font-size: 1.2rem; 
        }
        .modal-nav.prev { left: 0.5rem; }
        .modal-nav.next { right: 0.5rem; }
        .modal-close { 
            top: 0.5rem; 
            right: 0.5rem; 
            width: 44px; 
            height: 44px; 
            font-size: 1.5rem; 
        }
        .modal-content { padding: 1rem; }
    }
    
    @media (max-width: 480px) { 
        .image-grid { column-count: 1; }
        
        .header {
            flex-direction: column;
            gap: 0.75rem;
        }
        .header textarea,
        .header button {
            width: 100%;
        }
        
        .gallery-wrapper { padding: 0.75rem; }
        
        .modal-nav.prev { left: 0.25rem; }
        .modal-nav.next { right: 0.25rem; }
        .modal-close { top: 0.25rem; right: 0.25rem; }
        .modal-content { padding: 0.5rem; }
    }
    
    /* モバイルメニューオーバーレイ */
    .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .mobile-overlay.visible {
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .mobile-overlay { display: block; }
    }
</style>
</head>
<body>

<div class="mobile-overlay" id="mobileOverlay"></div>

<button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>

<div class="container">
    <aside class="sidebar" id="sidebar">
        <h2>
            X Gallery
            <button class="sidebar-close" id="sidebarClose">&times;</button>
        </h2>
        <input type="search" id="userSearch" class="search-box" placeholder="Search users...">
        <ul id="navList" class="nav-list"></ul>
    </aside>

    <main class="main-content">
        <header class="header">
            <textarea id="tweetUrls" placeholder="Enter Tweet URLs (separated by comma, space, or new line)" rows="1"></textarea>
            <button id="downloadBtn">Download</button>
        </header>
        <div id="status"></div>
        <div id="galleryWrapper" class="gallery-wrapper"></div>
    </main>
</div>

<div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
        <span id="modalClose" class="modal-close">&times;</span>
        <button id="modalPrev" class="modal-nav prev">&#10094;</button>
        <img id="modalImg" src="">
        <button id="modalNext" class="modal-nav next">&#10095;</button>
    </div>
</div>

<script>
    const G_ELEMENTS = {
        navList: document.getElementById('navList'),
        userSearch: document.getElementById('userSearch'),
        galleryWrapper: document.getElementById('galleryWrapper'),
        status: document.getElementById('status'),
        downloadBtn: document.getElementById('downloadBtn'),
        tweetUrls: document.getElementById('tweetUrls'),
        sidebar: document.getElementById('sidebar'),
        mobileMenuToggle: document.getElementById('mobileMenuToggle'),
        sidebarClose: document.getElementById('sidebarClose'),
        mobileOverlay: document.getElementById('mobileOverlay'),
        modal: {
            overlay: document.getElementById('modalOverlay'),
            img: document.getElementById('modalImg'),
            close: document.getElementById('modalClose'),
            prev: document.getElementById('modalPrev'),
            next: document.getElementById('modalNext'),
        }
    };

    let G_STATE = {
        activeNav: 'home',
        gallery: [],
        galleryIndex: 0,
    };

    // --- 初期化 ---
    document.addEventListener('DOMContentLoaded', () => {
        initNav();
        initEventListeners();
        loadRandomImages();
    });

    function initNav() {
        loadUsers();
    }

    function initEventListeners() {
        G_ELEMENTS.userSearch.addEventListener('input', () => loadUsers(G_ELEMENTS.userSearch.value));
        G_ELEMENTS.downloadBtn.addEventListener('click', handleDownload);
        
        // モバイルメニュー制御
        G_ELEMENTS.mobileMenuToggle.addEventListener('click', openSidebar);
        G_ELEMENTS.sidebarClose.addEventListener('click', closeSidebar);
        G_ELEMENTS.mobileOverlay.addEventListener('click', closeSidebar);
        
        const { overlay, close, prev, next, img } = G_ELEMENTS.modal;
        overlay.addEventListener('click', e => (e.target === overlay) && closeModal());
        close.addEventListener('click', closeModal);
        prev.addEventListener('click', () => changeModalImage(-1));
        next.addEventListener('click', () => changeModalImage(1));
        img.addEventListener('click', () => changeModalImage(1));
        document.addEventListener('keydown', e => {
            if (!overlay.classList.contains('visible')) return;
            if (e.key === 'ArrowRight') changeModalImage(1);
            if (e.key === 'ArrowLeft') changeModalImage(-1);
            if (e.key === 'Escape') closeModal();
        });
    }

    // --- モバイルメニュー制御 ---
    function openSidebar() {
        G_ELEMENTS.sidebar.classList.add('open');
        G_ELEMENTS.mobileOverlay.classList.add('visible');
        // モバイルでのスクロール防止は削除（入力に支障をきたすため）
    }

    function closeSidebar() {
        G_ELEMENTS.sidebar.classList.remove('open');
        G_ELEMENTS.mobileOverlay.classList.remove('visible');
        // body overflowの制御も削除
    }

    // --- API 通信 ---
    async function fetchAPI(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error(`Fetch error for ${url}:`, error);
            G_ELEMENTS.galleryWrapper.innerHTML = `<p class="placeholder">Failed to load data. Please try again.</p>`;
            return null;
        }
    }

    async function loadRandomImages() {
        setActiveNav('home');
        renderLoader();
        closeSidebar(); // モバイルでメニューを閉じる
        const data = await fetchAPI('/api/images/random');
        if (data) {
            const title = 'Top Gallery (Random 50)';
            if (data.images.length === 0) {
                renderPlaceholder(title, 'No images found. Start by downloading some!');
                return;
            }
            renderImageGrid(title, data.images);
        }
    }

    async function loadUsers(query = '') {
        const data = await fetchAPI(`/api/users?q=${encodeURIComponent(query)}`);
        if (data) renderNavList(data.users);
    }
    
    async function loadUserTweets(username) {
        setActiveNav(username);
        renderLoader();
        closeSidebar(); // モバイルでメニューを閉じる
        const data = await fetchAPI(`/api/users/${username}/tweets`);
        if (data) {
            G_ELEMENTS.galleryWrapper.innerHTML = '';
            const title = document.createElement('h3');
            title.className = 'gallery-title';
            title.textContent = `@${username}'s Gallery`;
            G_ELEMENTS.galleryWrapper.appendChild(title);

            if (data.tweets.length === 0) {
                renderPlaceholder(null, 'No tweets found for this user.');
                return;
            }
            
            data.tweets.forEach(tweet => {
                const tweetTitle = `Tweet ID: ${tweet.tweet_id}`;
                renderImageGrid(tweetTitle, tweet.images, true);
            });
        }
    }

    async function handleDownload() {
        const urls = G_ELEMENTS.tweetUrls.value.trim().split(/[\s,]+/).filter(Boolean);
        if (!urls.length) { alert("Please enter at least one URL."); return; }
        
        G_ELEMENTS.downloadBtn.disabled = true;
        G_ELEMENTS.status.textContent = "Downloading...";

        try {
            const response = await fetch('/api/download', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ urls })
            });
            const data = await response.json();
            const totalDownloaded = data.results.reduce((sum, r) => sum + (r.downloaded_count || 0), 0);
            G_ELEMENTS.status.textContent = `Completed! Downloaded ${totalDownloaded} images.`;
            G_ELEMENTS.tweetUrls.value = '';
            initNav(); // Refresh user list
        } catch (error) {
            G_ELEMENTS.status.textContent = "An error occurred during download.";
            console.error("Download error:", error);
        } finally {
            G_ELEMENTS.downloadBtn.disabled = false;
        }
    }

    // --- レンダリング & DOM操作 ---
    function renderNavList(users) {
        G_ELEMENTS.navList.innerHTML = '';
        // トップギャラリー項目を追加
        const homeLi = document.createElement('li');
        homeLi.dataset.navId = 'home';
        homeLi.innerHTML = `<span>🏠 Top Gallery</span>`;
        homeLi.onclick = loadRandomImages;
        G_ELEMENTS.navList.appendChild(homeLi);

        users.forEach(user => {
            const li = document.createElement('li');
            li.dataset.navId = user.username;
            li.innerHTML = `<span>${user.username}</span><span class="tweet-count">${user.tweet_count}</span>`;
            li.onclick = () => loadUserTweets(user.username);
            G_ELEMENTS.navList.appendChild(li);
        });
        setActiveNav(G_STATE.activeNav);
    }
    
    function renderImageGrid(title, images, append = false) {
        const gridContainer = document.createElement('div');
        if (title) {
            const gridTitle = document.createElement('h4');
            gridTitle.className = 'gallery-title';
            gridTitle.textContent = title;
            gridContainer.appendChild(gridTitle);
        }
        
        const grid = document.createElement('div');
        grid.className = 'image-grid';

        const imagePaths = images.map(img => `/images/${img.path}`);

        images.forEach((img, index) => {
            const container = document.createElement('div');
            container.className = 'img-container';
            const imageEl = document.createElement('img');
            imageEl.src = `/images/${img.path}`;
            imageEl.loading = 'lazy';
            imageEl.onclick = () => showModal(imagePaths, index);
            container.appendChild(imageEl);
            grid.appendChild(container);
        });
        gridContainer.appendChild(grid);

        if (!append) G_ELEMENTS.galleryWrapper.innerHTML = '';
        G_ELEMENTS.galleryWrapper.appendChild(gridContainer);
    }
    
    function renderLoader() {
        G_ELEMENTS.galleryWrapper.innerHTML = '<div class="loader"></div>';
    }

    function renderPlaceholder(title, message) {
        let html = '';
        if (title) html += `<h3 class="gallery-title">${title}</h3>`;
        html += `<p class="placeholder">${message}</p>`;
        G_ELEMENTS.galleryWrapper.innerHTML = html;
    }
    
    function setActiveNav(navId) {
        G_STATE.activeNav = navId;
        document.querySelectorAll('#navList li').forEach(li => {
            li.classList.toggle('active', li.dataset.navId === navId);
        });
    }

    // --- モーダル制御 ---
    function showModal(gallery, index) {
        G_STATE.gallery = gallery;
        G_STATE.galleryIndex = index;
        updateModalImage();
        G_ELEMENTS.modal.overlay.classList.add('visible');
    }

    function closeModal() {
        G_ELEMENTS.modal.overlay.classList.remove('visible');
    }

    function updateModalImage() {
        if (G_STATE.gallery.length > 0) {
            G_ELEMENTS.modal.img.src = G_STATE.gallery[G_STATE.galleryIndex];
        }
    }

    function changeModalImage(direction) {
        const newIndex = G_STATE.galleryIndex + direction;
        const len = G_STATE.gallery.length;
        G_STATE.galleryIndex = (newIndex % len + len) % len; // ループ処理
        updateModalImage();
    }
</script>
</body>
</html>
